<div class="background-slideshow">
  <div class="slide" style="background-image: url('assets/futuristic-background.jpg');"></div>
  <div class="slide" style="background-image: url('assets/futuristic-background2.jpg');"></div>
  <div class="slide" style="background-image: url('assets/futuristic-background3.jpg');"></div>
</div>

<div class="max-w-3xl mx-auto p-4">
  <header class="text-3xl font-bold text-center my-6">
    <h1>Global Feed</h1>
  </header>

  <div *ngIf="loading" class="text-center p-4">
    <p class="text-lg text-gray-600">Loading feed...</p>
  </div>

  <div *ngIf="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-center" role="alert">
    <p>{{ error }}</p>
  </div>

  <div *ngIf="!loading && albums.length === 0 && !error" class="text-center p-4 bg-gray-100 rounded-lg">
    <p class="text-lg text-gray-600">No albums found in the feed. Be the first to create one!</p>
  </div>

  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
  </div>

  <div *ngIf="!loading && albums.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <div *ngFor="let album of albums" class="bg-white shadow-md rounded-lg p-4 mb-4">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-xl font-semibold">{{ album.title }}</h3>
        <span class="px-2 py-1 bg-blue-200 text-blue-800 text-xs font-medium rounded-full">{{ album.type }}</span>
      </div>
      <p class="text-sm text-gray-600 mb-1">By: {{ album.author.fullName }} ({{ album.author.username }})</p>
      <p class="text-gray-700 mb-2">{{ album.description }}</p>
      <p *ngIf="album.location" class="text-xs text-gray-500">Location: {{ album.location }}</p>
      <p *ngIf="album.eventName" class="text-xs text-gray-500">Event: {{ album.eventName }}</p>

      <div *ngIf="album.posts && album.posts.length > 0" class="mt-4 border-t pt-4">
        <div *ngFor="let post of album.posts" class="bg-gray-50 p-3 rounded-lg mb-3 last:mb-0">
          <div class="mb-2">
            <img *ngIf="post.type === 'PHOTO' && post.mediaUrl" [src]="resolveMediaUrl(post.mediaUrl)" alt="Photo Post" class="w-full h-auto rounded-md">
            <div *ngIf="post.type === 'VIDEO' && post.mediaUrl" class="relative" style="padding-bottom: 56.25%; height: 0;">
              <iframe *ngIf="isYouTubeVideo(post.mediaUrl); else genericVideo" [src]="getYouTubeEmbedUrl(post.mediaUrl)" frameborder="0" allowfullscreen class="absolute top-0 left-0 w-full h-full rounded-md"></iframe>
              <ng-template #genericVideo>
                <video [src]="resolveMediaUrl(post.mediaUrl)" controls class="w-full h-auto rounded-md"></video>
              </ng-template>
            </div>
          </div>
          <div class="text-sm">
            <p class="text-gray-800 mb-1">{{ post.caption }}</p>
            <p class="text-xs text-gray-500">{{ post.createdAt | date:'medium' }}</p>

            <!-- Ações do autor -->
            <div class="mt-2 flex space-x-2" *ngIf="canEditPost(post)">
              <a class="px-3 py-1 text-sm rounded bg-yellow-500 text-white hover:bg-yellow-600" [routerLink]="['/edit-post', post.id]">Editar</a>
              <button class="px-3 py-1 text-sm rounded bg-red-600 text-white hover:bg-red-700" (click)="deletePost(post.id)">Excluir</button>
            </div>

            <!-- Moderação ADMIN -->
            <div class="mt-2 flex space-x-2" *ngIf="isAdmin && !canEditPost(post)">
              <a class="px-3 py-1 text-sm rounded bg-purple-600 text-white hover:bg-purple-700" [routerLink]="['/edit-post', post.id]">Editar (Admin)</a>
              <button class="px-3 py-1 text-sm rounded bg-red-700 text-white hover:bg-red-800" (click)="adminDeletePost(post.id)">Excluir (Admin)</button>
            </div>

            <!-- Comentários -->
            <div class="mt-3">
              <button class="px-3 py-1 text-sm rounded bg-gray-200 hover:bg-gray-300" (click)="toggleComments(post.id)">
                {{ showComments[post.id] ? 'Ocultar comentários' : 'Mostrar comentários' }}
              </button>

              <div *ngIf="showComments[post.id]" class="mt-3 border-t pt-3">
                <!-- Lista de comentários -->
                <div *ngIf="commentsByPostId[post.id] && commentsByPostId[post.id].length > 0; else semComentarios">
                  <div *ngFor="let comment of commentsByPostId[post.id]" class="mb-2">
                    <p class="text-sm text-gray-800">{{ comment.text }}</p>
                    <p class="text-xs text-gray-500">Por: {{ comment.author?.fullName || comment.author?.username }} • {{ comment.createdAt | date:'short' }}</p>
                    <button *ngIf="canDeleteComment(comment)" class="text-xs text-red-600 hover:underline" (click)="deleteComment(comment.id, post.id)">Excluir</button>
                  </div>
                </div>
                <ng-template #semComentarios>
                  <p class="text-sm text-gray-500">Ainda não há comentários.</p>
                </ng-template>

                <!-- Adicionar comentário -->
                <div class="mt-2" *ngIf="isAuthenticated; else precisaLogin">
                  <input class="w-full border rounded p-2 text-sm" [(ngModel)]="newCommentText[post.id]" placeholder="Escreva um comentário..." />
                  <button class="mt-2 px-3 py-1 text-sm rounded bg-blue-600 text-white hover:bg-blue-700" (click)="addComment(post.id)">Enviar</button>
                </div>
                <ng-template #precisaLogin>
                  <p class="text-sm text-gray-500">Faça login para comentar.</p>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white shadow-md rounded-lg p-4 mb-4">
    <h3 class="text-lg font-semibold mb-2">Buscar Posts</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <input class="border rounded p-2" type="text" placeholder="Texto (caption)" [(ngModel)]="search.q">
      <select class="border rounded p-2" [(ngModel)]="search.type">
        <option value="">Tipo</option>
        <option value="PHOTO">Foto</option>
        <option value="VIDEO">Vídeo</option>
      </select>
      <input class="border rounded p-2" type="text" placeholder="Autor (username)" [(ngModel)]="search.author">
    </div>
    <button class="mt-3 px-4 py-2 bg-blue-600 text-white rounded" (click)="onSearch()">Buscar</button>
  </div>
</div>
